<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="BuyMapper">

   <!-- 상품 생성  -->
	<insert id="buyAdd" parameterType="Buy">
		INSERT INTO buy (
			buy_code,
			item_code,
			user_idx,
			quantity,
			color,
			size,
			status,
			date
		) VALUES (
			#{buy_code},
			#{item_code},
			#{user_idx},
			#{quantity},
			#{color},
			#{size},
			'ACTIVE',
			NOW()
		)
	</insert>

	<!-- 구매 횟수 증가 -->
	<update id="buyCountUpdate" parameterType="map">
		UPDATE item 
		SET buy_count = buy_count + #{quantity}
		WHERE item_code = #{item_code}
	</update>

	<!-- 회원 구매 목록 상세 조회 -->
	<select id="buyListDetail" parameterType="int" resultType="map">
		SELECT b.*, i.name as item_name, i.item_img_url, i.price * b.quantity as total_price
		FROM buy b
		JOIN item i ON b.item_code = i.item_code
		WHERE b.user_idx = #{user_idx}
		AND b.status = 'ACTIVE'
		ORDER BY b.date DESC
	</select>

	<!-- 상품별 구매 횟수 조회 -->
	<select id="getItemBuyCount" resultType="int" parameterType="string">
		SELECT COUNT(*) 
		FROM buy 
		WHERE item_code = #{item_code}
	</select>

	<!-- 주문 취소 -->
	<update id="orderCancel" parameterType="map">
		UPDATE buy 
		SET status = 'CANCELLED'
		WHERE item_code IN 
		<foreach item="itemCode" collection="itemCodes" open="(" separator="," close=")">
			#{itemCode}
		</foreach>
		AND user_idx = #{userIdx}
	</update>

	<!-- item_code와 user_idx로 구매 정보 조회 -->
	<select id="findByItemCodeAndUserIdx" resultType="com.my.shop.entity.Buy">
		SELECT *
		FROM buy
		WHERE item_code = #{itemCode}
		AND user_idx = #{userIdx}
		AND status != 'CANCELLED'
		ORDER BY buy_idx DESC
		LIMIT 1
	</select>

</mapper>

